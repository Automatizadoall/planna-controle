{
  "name": "Planna - WhatsApp Transactions",
  "nodes": [
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "whatsapp-transaction",
        "options": {}
      },
      "id": "webhook-trigger",
      "name": "Webhook WhatsApp",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [250, 300],
      "webhookId": "planna-whatsapp"
    },
    {
      "parameters": {
        "jsCode": "// Extrai dados da mensagem do WhatsApp\n// Adapte conforme seu provider (Evolution API, Twilio, etc)\n\nconst body = $input.first().json;\n\n// Exemplo para Evolution API\nlet phone = body.data?.key?.remoteJid || body.from;\nlet message = body.data?.message?.conversation || \n              body.data?.message?.extendedTextMessage?.text ||\n              body.message || body.text;\n\n// Limpa o n√∫mero de telefone\nif (phone) {\n  // Remove @s.whatsapp.net e caracteres especiais\n  phone = phone.replace('@s.whatsapp.net', '')\n               .replace('@c.us', '')\n               .replace(/[^0-9+]/g, '');\n  \n  // Adiciona + se n√£o tiver\n  if (!phone.startsWith('+')) {\n    phone = '+' + phone;\n  }\n}\n\nreturn {\n  phone: phone,\n  message: message,\n  raw: body\n};"
      },
      "id": "extract-data",
      "name": "Extrair Dados",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [470, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/rpc/get_user_by_phone",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SERVICE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ p_phone: $json.phone }) }}"
      },
      "id": "lookup-user",
      "name": "Buscar Usu√°rio",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [690, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "user-found",
              "leftValue": "={{ $json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-user",
      "name": "Usu√°rio Existe?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [910, 300]
    },
    {
      "parameters": {
        "jsCode": "// Parse da mensagem para extrair dados da transa√ß√£o\n// Formatos aceitos:\n// \"gastei 50 mercado\" ‚Üí expense\n// \"recebi 1000 sal√°rio\" ‚Üí income\n// \"50.90 uber\" ‚Üí expense (default)\n// \"entrada 500 freelance\" ‚Üí income\n\nconst message = $('Extrair Dados').first().json.message?.toLowerCase() || '';\nconst userData = $input.first().json;\n\n// Palavras-chave para tipo\nconst incomeKeywords = ['recebi', 'recebido', 'entrada', 'ganho', 'ganhei', 'sal√°rio', 'salario', 'pix recebido'];\nconst expenseKeywords = ['gastei', 'gasto', 'paguei', 'comprei', 'sa√≠da', 'saida', 'd√©bito', 'debito'];\n\n// Detecta tipo\nlet type = 'expense'; // default\nfor (const kw of incomeKeywords) {\n  if (message.includes(kw)) {\n    type = 'income';\n    break;\n  }\n}\n\n// Extrai valor (procura n√∫meros com ou sem decimais)\nconst valueMatch = message.match(/(\\d+[.,]?\\d*)/); \nconst amount = valueMatch ? parseFloat(valueMatch[1].replace(',', '.')) : null;\n\n// Extrai descri√ß√£o (remove valor e palavras-chave)\nlet description = message\n  .replace(/(\\d+[.,]?\\d*)/g, '')\n  .replace(new RegExp(incomeKeywords.join('|'), 'gi'), '')\n  .replace(new RegExp(expenseKeywords.join('|'), 'gi'), '')\n  .replace(/\\s+/g, ' ')\n  .trim();\n\nif (!description) {\n  description = type === 'income' ? 'Entrada via WhatsApp' : 'Despesa via WhatsApp';\n}\n\n// Data atual\nconst today = new Date().toISOString().split('T')[0];\n\nreturn {\n  user_id: userData.user_id,\n  account_id: userData.default_account_id,\n  account_name: userData.default_account_name,\n  full_name: userData.full_name,\n  type: type,\n  amount: amount,\n  description: description.charAt(0).toUpperCase() + description.slice(1),\n  date: today,\n  original_message: message,\n  is_valid: amount !== null && amount > 0\n};"
      },
      "id": "parse-transaction",
      "name": "Processar Mensagem",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1130, 200]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "valid-amount",
              "leftValue": "={{ $json.is_valid }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            },
            {
              "id": "has-account",
              "leftValue": "={{ $json.account_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "isNotEmpty"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "check-valid",
      "name": "Dados V√°lidos?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [1350, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.SUPABASE_URL }}/rest/v1/transactions",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.SUPABASE_SERVICE_KEY }}"
            },
            {
              "name": "Authorization",
              "value": "Bearer {{ $env.SUPABASE_SERVICE_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"user_id\": \"{{ $json.user_id }}\",\n  \"account_id\": \"{{ $json.account_id }}\",\n  \"type\": \"{{ $json.type }}\",\n  \"amount\": {{ $json.amount }},\n  \"description\": \"{{ $json.description }}\",\n  \"date\": \"{{ $json.date }}\"\n}"
      },
      "id": "create-transaction",
      "name": "Criar Transa√ß√£o",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1570, 100]
    },
    {
      "parameters": {
        "jsCode": "// Monta mensagem de confirma√ß√£o\nconst tx = $('Processar Mensagem').first().json;\nconst created = $input.first().json;\n\nconst typeLabel = tx.type === 'income' ? 'üí∞ Entrada' : 'üí∏ Sa√≠da';\nconst amount = new Intl.NumberFormat('pt-BR', { \n  style: 'currency', \n  currency: 'BRL' \n}).format(tx.amount);\n\nconst message = `‚úÖ *Transa√ß√£o registrada!*\n\n${typeLabel}\nüìù ${tx.description}\nüíµ ${amount}\nüè¶ ${tx.account_name}\nüìÖ ${tx.date}\n\n_Registrado via Planna_`;\n\nreturn {\n  phone: $('Extrair Dados').first().json.phone,\n  message: message,\n  transaction_id: created[0]?.id || created.id\n};"
      },
      "id": "success-message",
      "name": "Mensagem Sucesso",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1790, 100]
    },
    {
      "parameters": {
        "jsCode": "// Mensagem de erro - dados inv√°lidos\nconst tx = $('Processar Mensagem').first().json;\nconst phone = $('Extrair Dados').first().json.phone;\n\nlet errorMsg = '‚ùå *N√£o consegui entender sua mensagem*\\n\\n';\n\nif (!tx.amount || tx.amount <= 0) {\n  errorMsg += '‚Ä¢ N√£o encontrei um valor v√°lido\\n';\n}\n\nif (!tx.account_id) {\n  errorMsg += '‚Ä¢ Voc√™ n√£o tem uma conta padr√£o definida\\n';\n}\n\nerrorMsg += `\\nüìù *Exemplos de uso:*\\n`;\nerrorMsg += `‚Ä¢ \"gastei 50 mercado\"\\n`;\nerrorMsg += `‚Ä¢ \"recebi 1000 sal√°rio\"\\n`;\nerrorMsg += `‚Ä¢ \"45.90 uber\"\\n`;\nerrorMsg += `\\n_Acesse o app para configurar sua conta padr√£o_`;\n\nreturn {\n  phone: phone,\n  message: errorMsg\n};"
      },
      "id": "error-invalid",
      "name": "Erro: Dados Inv√°lidos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1570, 300]
    },
    {
      "parameters": {
        "jsCode": "// Mensagem de erro - usu√°rio n√£o encontrado\nconst phone = $('Extrair Dados').first().json.phone;\n\nconst message = `‚ùå *N√∫mero n√£o cadastrado*\n\nO n√∫mero ${phone} n√£o est√° vinculado a nenhuma conta Planna.\n\nüì± *Para vincular:*\n1. Acesse o app Planna\n2. V√° em Configura√ß√µes\n3. Adicione seu n√∫mero de telefone\n\n_Ap√≥s vincular, voc√™ poder√° registrar transa√ß√µes por aqui!_`;\n\nreturn {\n  phone: phone,\n  message: message\n};"
      },
      "id": "error-not-found",
      "name": "Erro: Usu√°rio N√£o Encontrado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1130, 400]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.WHATSAPP_API_URL }}/message/sendText/{{ $env.WHATSAPP_INSTANCE }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.WHATSAPP_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $json.phone.replace('+', '') }}\",\n  \"text\": \"{{ $json.message.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n}"
      },
      "id": "send-whatsapp-1",
      "name": "Enviar WhatsApp (Sucesso)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2010, 100]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.WHATSAPP_API_URL }}/message/sendText/{{ $env.WHATSAPP_INSTANCE }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{ $env.WHATSAPP_API_KEY }}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"number\": \"{{ $json.phone.replace('+', '') }}\",\n  \"text\": \"{{ $json.message.replace(/\"/g, '\\\\\"').replace(/\\n/g, '\\\\n') }}\"\n}"
      },
      "id": "send-whatsapp-2",
      "name": "Enviar WhatsApp (Erro)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1790, 350]
    },
    {
      "parameters": {},
      "id": "merge-errors",
      "name": "Merge Erros",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [1570, 400]
    }
  ],
  "connections": {
    "Webhook WhatsApp": {
      "main": [
        [
          {
            "node": "Extrair Dados",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extrair Dados": {
      "main": [
        [
          {
            "node": "Buscar Usu√°rio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Buscar Usu√°rio": {
      "main": [
        [
          {
            "node": "Usu√°rio Existe?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Usu√°rio Existe?": {
      "main": [
        [
          {
            "node": "Processar Mensagem",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erro: Usu√°rio N√£o Encontrado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Mensagem": {
      "main": [
        [
          {
            "node": "Dados V√°lidos?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Dados V√°lidos?": {
      "main": [
        [
          {
            "node": "Criar Transa√ß√£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Erro: Dados Inv√°lidos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Criar Transa√ß√£o": {
      "main": [
        [
          {
            "node": "Mensagem Sucesso",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Mensagem Sucesso": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp (Sucesso)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Erro: Dados Inv√°lidos": {
      "main": [
        [
          {
            "node": "Merge Erros",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Erro: Usu√°rio N√£o Encontrado": {
      "main": [
        [
          {
            "node": "Merge Erros",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Merge Erros": {
      "main": [
        [
          {
            "node": "Enviar WhatsApp (Erro)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Planna",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    },
    {
      "name": "WhatsApp",
      "createdAt": "2024-01-01T00:00:00.000Z",
      "updatedAt": "2024-01-01T00:00:00.000Z"
    }
  ],
  "triggerCount": 1,
  "pinData": {}
}


